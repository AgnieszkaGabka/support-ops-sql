-- Day 3: Time-based trends and operational insights
-- Focus: ticket volume trends, backlog trend, SLA compliance over time
-- Business question:
-- Is ticket volume increasing over time?
-- This query shows daily ticket creation trend.

-- 1) Tickets created per day (trend)
SELECT
  substr(created_at, 1, 10) AS created_date,
  COUNT(*) AS tickets_created
FROM tickets
GROUP BY 1
ORDER BY 1;

-- 2) Tickets resolved per day
SELECT
  substr(resolved_at, 1, 10) AS resolved_date,
  COUNT(*) AS tickets_resolved
FROM tickets
WHERE resolved_at IS NOT NULL
GROUP BY 1
ORDER BY 1;

-- 3) Open tickets snapshot by creation date
-- (how many tickets created on each day are still open/pending)
SELECT
  substr(created_at, 1, 10) AS created_date,
  COUNT(*) AS still_open
FROM tickets
WHERE status IN ('Open','Pending')
GROUP BY 1
ORDER BY 1;

-- 4) SLA compliance trend by creation date
SELECT
  substr(created_at, 1, 10) AS created_date,
  COUNT(*) AS total_tickets,
  SUM(
    CASE
      WHEN resolved_at IS NOT NULL
       AND (julianday(resolved_at) - julianday(created_at)) * 24 * 60 <= sla_minutes
      THEN 1
      ELSE 0
    END
  ) AS met_sla,
  ROUND(
    100.0 * SUM(
      CASE
        WHEN resolved_at IS NOT NULL
         AND (julianday(resolved_at) - julianday(created_at)) * 24 * 60 <= sla_minutes
        THEN 1
        ELSE 0
      END
    ) / COUNT(*),
    1
  ) AS sla_compliance_pct
FROM tickets
GROUP BY 1
ORDER BY 1;

-- 5) Ticket volume by weekday (operational pattern)
SELECT
  strftime('%w', created_at) AS weekday_number,
  COUNT(*) AS tickets_created
FROM tickets
GROUP BY 1
ORDER BY 1;
